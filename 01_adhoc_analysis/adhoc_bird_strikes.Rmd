---
title: "Using `pointblank` in ad hoc analysis"
author: "Katie Masiello"
date: "2/15/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Say you just received a new project and you've just gotten your hands on the first batch of data. Let's go through some steps to explore this data with the help of `pointblank`

```{r packages, include = FALSE}
library(tidyverse)
library(pointblank)
```

### Bring in the data

We're going to bring in data from the FAA Wildlife Strike Database with data from 1990 to 2018.

```{r}
strikes <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-07-23/wildlife_impacts.csv")

```

### Scan the data 
There are many ways to get a feel for the data, including `summary(strikes)` or `skimr::skim(strikes)`

```{r}
summary(strikes)
skimr::skim(strikes)
```

Pointblank offers the `scan_data()` function to provide a comprehensive view of the data. (this can take some time to run... be patient, or consider running this as a background job)

```{r eval=FALSE, include=FALSE}
# Commenting this out to prevent accidentally initiating scan.  It can take a while.
# File is also saved as scan_data.R and can be run as a Background Job using the Local Launcher.
# scan <- scan_data(strikes)
load(here::here("01_adhoc_analysis","reports","scan_data.rds"))
print(scan)
```

### Establish data validation rules

The results of scan_data give us some good hints for data validation issues and things to be watchful for. Namely:

1.  `incident_date` should have a value. Don't pass NAs
1.  `state` should be a two-letter abbreviation\
1.  `airport_id` should be a four-letter code\
1.  Flight phase can be cross checked with height, though this could be a bit inaccurate since we are not taking into account airport elevation:
  a.  climb < 1000 ft
  a.  en route >= 1000 ft
  a.  descent > 1000 ft  
  a.  approach <= 1000 ft
  a. ground ops (arrival, departure, landing roll, local, parked, take-off run, taxi) should be at a low altitude

### Create an agent for validation

```{r agent}
(agent <- strikes %>% 
  create_agent() %>% 
  col_vals_not_null(vars(incident_date)) %>% 
  col_vals_expr(expr = ~ str_length(state) == 2) %>% 
  col_vals_expr(expr = ~ str_length(airport_id) == 4) %>%  
  col_vals_lt(vars(height), value = 1000, preconditions = ~. %>% 
                dplyr::filter(!is.na(height)) %>% 
                dplyr::filter(tolower(phase_of_flt) == "climb")) %>% 
  col_vals_gte(vars(height), value = 1000, preconditions = ~. %>% 
                dplyr::filter(!is.na(height)) %>% 
                dplyr::filter(tolower(phase_of_flt) == "en route")) %>% 
  col_vals_gt(vars(height), value = 1000, preconditions = ~. %>% 
                dplyr::filter(!is.na(height)) %>% 
                dplyr::filter(tolower(phase_of_flt) == "descent")) %>% 
  col_vals_lte(vars(height), value = 1000, preconditions = ~. %>% 
                dplyr::filter(!is.na(height)) %>% 
                dplyr::filter(tolower(phase_of_flt) == "approach")) %>% 
  interrogate() )

```

```{r validate = TRUE}
col_vals_not_null(strikes, vars(incident_date))
col_vals_expr(strikes, expr = ~ str_length(state) == 2)
col_vals_expr(strikes, expr = ~ str_length(airport_id) == 4) 
col_vals_lt(strikes, vars(height), value = 1000, preconditions = ~. %>% 
              dplyr::filter(!is.na(height)) %>% 
              dplyr::filter(tolower(phase_of_flt) == "climb")) 
col_vals_gte(strikes, vars(height), value = 1000, preconditions = ~. %>% 
               dplyr::filter(!is.na(height)) %>% 
               dplyr::filter(tolower(phase_of_flt) == "en route")) 
col_vals_gt(strikes, vars(height), value = 1000, preconditions = ~. %>% 
              dplyr::filter(!is.na(height)) %>% 
              dplyr::filter(tolower(phase_of_flt) == "descent")) 
col_vals_lte(strikes, vars(height), value = 1000, preconditions = ~. %>% 
               dplyr::filter(!is.na(height)) %>% 
               dplyr::filter(tolower(phase_of_flt) == "approach"))
```


